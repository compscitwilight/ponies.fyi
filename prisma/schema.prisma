datasource db {
    provider = "postgresql"
}

generator client {
    provider = "prisma-client"
    output   = "../src/generated/"
}

enum PonysonaStatus {
    Pending
    Approved
    Hidden
}

model SiteSettings {
    key   String  @id
    value String?
}

model Profile {
    userId                 String     @id
    alias                  String?
    isAdmin                Boolean    @default(false)
    canUpload              Boolean    @default(true) // only applies to gallery images
    canRemoveGalleryImages Boolean    @default(true)
    submittedPonysonas     Ponysona[]
    createdAt              DateTime   @default(now())
    updatedAt              DateTime   @updatedAt
}

model Ponysona {
    id          String         @id @default(uuid())
    slug        String         @unique
    originalId  String? /* used by ponysonas that are derivative forms of another */
    primaryName String
    otherNames  String[]
    description String?
    status      PonysonaStatus @default(Pending)
    locked      Boolean        @default(false)

    tags        PonysonaTag[]                 @relation("TagName")
    sources     String[]
    creators    String[]
    colorsName  String[]
    revisions   PonysonaRevision[]
    attributes  PonysonaAppearanceAttribute[]
    accessories PonysonaAccessory[]
    derivatives Ponysona[]                    @relation("derivatives")

    submittedById String?
    submittedBy   Profile? @relation(fields: [submittedById], references: [userId])

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    original Ponysona? @relation(name: "derivatives", fields: [originalId], references: [id])
    media    Media[]

    relationshipsA PonysonaRelationship[] @relation("PonysonaARel")
    relationshipsB PonysonaRelationship[] @relation("PonysonaBRel")
}

enum MediaType {
    preview
    mark
    gallery
}

enum MediaStatus {
    pending /* added */
    uploaded /* pushed */
    finalized /* committed */
}

model Media {
    id          String      @id @default(uuid())
    ponysonaId  String?
    type        MediaType   @default(gallery)
    status      MediaStatus @default(pending)
    size        String?
    description String?

    // attribution
    source  String?
    creator String?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    ponysona Ponysona? @relation(fields: [ponysonaId], references: [id])
}

enum BodyPart {
    mane
    tail
    coat
    wings
    horn
    eyes
}

enum Pattern {
    solid
    striped
    streak
    spotted
}

model PonysonaAppearanceAttribute {
    id         String   @id @default(uuid())
    ponysonaId String
    bodyPart   BodyPart
    colors     String[]
    pattern    Pattern  @default(solid)

    ponysona  Ponysona @relation(fields: [ponysonaId], references: [id])
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@unique([ponysonaId, bodyPart])
}

model PonysonaAccessory {
    id         Int      @id @default(autoincrement())
    ponysonaId String
    name       String
    colors     String[]
    pattern    Pattern  @default(solid)

    ponysona Ponysona @relation(fields: [ponysonaId], references: [id])

    @@unique([ponysonaId, name])
}

model PonysonaRevision {
    id         String @id @default(uuid())
    ponysonaId String

    diff     Int
    snapshot Json

    createdById String?

    createdAt DateTime @default(now())
    ponysona  Ponysona @relation(fields: [ponysonaId], references: [id])
}

enum RelationshipType {
    friends
    siblings
    parent_child
    enemies
}

enum RelationshipDirection {
    AB
    BA
}

model PonysonaRelationship {
    id        Int                   @id @default(autoincrement())
    type      RelationshipType
    direction RelationshipDirection @default(AB)

    ponysonaAId String
    ponysonaA   Ponysona @relation("PonysonaARel", fields: [ponysonaAId], references: [id])

    ponysonaBId String
    ponysonaB   Ponysona @relation("PonysonaBRel", fields: [ponysonaBId], references: [id])

    label     String?
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
}

enum TagType {
    species
    form
    role
    setting
    genre
    trait
}

model PonysonaTag {
    id        Int        @id @default(autoincrement())
    name      String     @unique
    type      TagType
    ponysonas Ponysona[] @relation("TagName")
}
